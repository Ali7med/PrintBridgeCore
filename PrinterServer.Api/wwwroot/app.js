const statusEl = document.getElementById("status");
const tabs = document.querySelectorAll(".tab");
const panels = { settings: document.getElementById("tab-settings"), token: document.getElementById("tab-token"), history: document.getElementById("tab-history"), test: document.getElementById("tab-test") };
const tokenKey = "printerServerToken";
let activeTab = "settings";
let historyTimer = null;
const el = (id) => document.getElementById(id);
const setStatus = (m) => { if (statusEl) statusEl.textContent = m; };
const getTokenHeader = () => { const t = (el("currentToken")?.value || "").trim(); return t ? { "X-Print-Token": t } : {}; };
async function apiRequest(path, options = {}) { const headers = Object.assign({ "Content-Type": "application/json" }, getTokenHeader(), options.headers || {}); const res = await fetch(path, Object.assign({}, options, { headers })); if (!res.ok) { const text = await res.text(); throw new Error(text || res.statusText); } if (res.status === 204) return null; return res.json(); }
async function loadPrinters() { const sel = el("defaultPrinter"); if (!sel) return; const data = await apiRequest("/printers"); sel.innerHTML = ""; (data.printers || []).forEach(p => { const o = document.createElement("option"); o.value = p.name; o.textContent = p.name + (p.isDefault ? " (System Default)" : ""); sel.appendChild(o); }); }
async function loadSettings() { const s = await apiRequest("/settings"); if (el("rawMode")) el("rawMode").value = s.rawMode || "winspool"; if (el("rawTcpHost")) el("rawTcpHost").value = s.rawTcpHost || ""; if (el("rawTcpPort")) el("rawTcpPort").value = s.rawTcpPort || 9100; if (el("rawEncoding")) el("rawEncoding").value = s.rawEncoding || "utf-8"; if (el("rawTerminator")) el("rawTerminator").value = s.rawTerminator || ""; if (el("allowLocalNoToken")) el("allowLocalNoToken").value = s.allowLocalNoToken ? "true" : "false"; if (el("maxFileSizeMb")) el("maxFileSizeMb").value = s.maxFileSizeMb || 20; if (el("defaultPrinter") && s.defaultPrinter) el("defaultPrinter").value = s.defaultPrinter; }
async function saveSettings() { const payload = { defaultPrinter: el("defaultPrinter")?.value || null, rawMode: el("rawMode")?.value || "winspool", rawTcpHost: el("rawTcpHost")?.value || null, rawTcpPort: Number(el("rawTcpPort")?.value || 9100), rawEncoding: el("rawEncoding")?.value || "utf-8", rawTerminator: el("rawTerminator")?.value || "", allowLocalNoToken: (el("allowLocalNoToken")?.value || "true") === "true", maxFileSizeMb: Number(el("maxFileSizeMb")?.value || 20) }; await apiRequest("/settings", { method: "PUT", body: JSON.stringify(payload) }); }
async function generateToken() { const data = await apiRequest("/token/generate", { method: "POST" }); if (el("currentToken")) { el("currentToken").value = data.token || ""; localStorage.setItem(tokenKey, el("currentToken").value); } }
async function disableToken() { await apiRequest("/token/disable", { method: "POST" }); if (el("currentToken")) { el("currentToken").value = ""; localStorage.removeItem(tokenKey); } }
function formatSize(bytes) { if (!bytes) return "0"; if (bytes < 1024) return bytes + " B"; if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB"; return (bytes / (1024 * 1024)).toFixed(2) + " MB"; }
async function loadHistory() { const rows = el("historyRows"); if (!rows) return; const params = new URLSearchParams(); if (el("historyStatus")?.value) params.append("status", el("historyStatus").value); if (el("historyPrinter")?.value) params.append("printer", el("historyPrinter").value); if (el("historyFrom")?.value) params.append("from", new Date(el("historyFrom").value).toISOString()); if (el("historyTo")?.value) params.append("to", new Date(el("historyTo").value).toISOString()); if (el("historyLimit")?.value) params.append("limit", el("historyLimit").value); const data = await apiRequest("/history?" + params.toString()); rows.innerHTML = ""; (data.items || []).forEach(item => { const row = document.createElement("div"); row.className = "row"; row.innerHTML = [new Date(item.time).toLocaleString(), item.type, item.printer, item.status, formatSize(item.size || 0), item.clientIp, item.error || ""].map(c => "<div>" + c + "</div>").join(""); rows.appendChild(row); }); }
function stopHistoryAuto() { if (historyTimer) { clearInterval(historyTimer); historyTimer = null; } }
function startHistoryAuto() { stopHistoryAuto(); if (!el("historyAuto") || !el("historyAuto").checked || activeTab !== "history") return; const seconds = Math.max(2, Math.min(60, parseInt(el("historyInterval")?.value || "5", 10))); historyTimer = setInterval(() => { if (activeTab !== "history") return; loadHistory().catch(err => setStatus("Error: " + err.message)); }, seconds * 1000); }
async function sendTestPrint() { const payload = new FormData(); payload.append("type", el("testType")?.value || "text"); if (el("testPrinter")?.value) payload.append("printer", el("testPrinter").value); if (el("testRawMode")?.value) payload.append("rawMode", el("testRawMode").value); if (el("testText")?.value) payload.append("text", el("testText").value); if (el("testFile")?.files && el("testFile").files[0]) payload.append("file", el("testFile").files[0]); const res = await fetch("/print", { method: "POST", headers: getTokenHeader(), body: payload }); if (!res.ok) { const text = await res.text(); throw new Error(text || res.statusText); } const data = await res.json(); if (el("testResult")) el("testResult").textContent = "Job: " + data.jobId + " | " + data.status + " | " + data.printer; }
function bindTabs() { tabs.forEach(tab => { tab.addEventListener("click", () => { tabs.forEach(t => t.classList.remove("active")); tab.classList.add("active"); activeTab = tab.dataset.tab; Object.keys(panels).forEach(key => { if (panels[key]) panels[key].classList.toggle("hidden", key !== activeTab); }); if (activeTab === "history") loadHistory().catch(err => setStatus("Error: " + err.message)); startHistoryAuto(); }); }); }
async function clearHistory() { if (!confirm("Are you sure you want to clear all history?")) return; await apiRequest("/history", { method: "DELETE" }); await loadHistory(); }
function bindActions() { el("refreshPrinters")?.addEventListener("click", () => loadPrinters().catch(err => setStatus("Error: " + err.message))); el("saveSettings")?.addEventListener("click", () => saveSettings().then(() => setStatus("Settings saved")).catch(err => setStatus("Error: " + err.message))); el("generateToken")?.addEventListener("click", () => generateToken().then(() => setStatus("Token generated")).catch(err => setStatus("Error: " + err.message))); el("disableToken")?.addEventListener("click", () => disableToken().then(() => setStatus("Token disabled")).catch(err => setStatus("Error: " + err.message))); el("refreshHistory")?.addEventListener("click", () => loadHistory().catch(err => setStatus("Error: " + err.message))); el("clearHistory")?.addEventListener("click", () => clearHistory().then(() => setStatus("History cleared")).catch(err => setStatus("Error: " + err.message))); el("historyAuto")?.addEventListener("change", startHistoryAuto); el("historyInterval")?.addEventListener("change", startHistoryAuto); el("sendTest")?.addEventListener("click", () => sendTestPrint().then(() => setStatus("Test print queued")).catch(err => { setStatus("Error: " + err.message); if (el("testResult")) el("testResult").textContent = err.message; })); el("currentToken")?.addEventListener("input", () => localStorage.setItem(tokenKey, el("currentToken").value.trim())); }
async function init() { bindTabs(); bindActions(); if (el("currentToken")) el("currentToken").value = localStorage.getItem(tokenKey) || ""; try { await loadPrinters(); await loadSettings(); } catch (err) { setStatus("Error: " + err.message); } }
init();
